#!/usr/bin/env bash
# To run test locally: make network-start && ./scripts/test-local/ethereum-processes.sh

set -e
set -x
. /etc/profile
. ./scripts/sekai-env.sh

TEST_NAME="ETHEREUM" && timerStart $TEST_NAME
echoInfo "INFO: $TEST_NAME - Integration Test - START"
echoInfo "INFO: Ethereum TX relay..."

addAccount tester

VALIDATOR_ADDRESS=$(showAddress validator)
ACCOUNT_ADDRESS=$(showAddress tester)

sendTokens "$VALIDATOR_ADDRESS" "$ACCOUNT_ADDRESS" 1000000000000 ukex 100 ukex

# Send tokens with ethereum relay --->

  # TEST 1
  # ---> Send tokens
  echoInfo "TEST 1"
  ETH_DATA="0a2a307831323334353637383930616263646566313233343536373839306162636465663132333435363738122c30786162636465666162636465666162636465666162636465666162636465666162636465666162636465661a07313030303030302201312a0b32303030303030303030303201303ac703307866323432343332613030303030303030303030303030303030303030303030303132333435363738393061626364656631323334353637383930616263646566313233343536373830303030303030303030303030303030303030303030303061626364656661626364656661626364656661626364656661626364656661626364656661626364656630303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303634307830613237306132383061313432643739373833313332323933333232323433313733326336343332333832653533366233333232366533343437323236653333363436393333346533333765333336343665333336343665333436653333376533333765326133363261323136313633363336663735366537343264373336333662326634643733363735333635366536343132316230613132326436353733363832323333323133313332333332633331333433343232323665366636343232333431343131326333313161313030613039363336313732363436313634363436393133313034303131303030303661393230303030303040014a043078323652423078346233613765366635643663386233613766356334623361366437653866356334623361376635653464356136623363376436653866356234633361376536665a42307836623738393362346636643561376535633762336136643765386635633462336137663565346435613662336337643665386635623463336137653666356434"
  TESTER_BALANCE_EXPECTED=$((1000000000000 - 150 - 100)) # -150 fee -100 coded in the ethereum tx

  ethereumTxRelay tester "$ETH_DATA" 150 ukex

  TESTER_BALANCE_REAL=$(showBalance tester ukex)

  [ "$TESTER_BALANCE_EXPECTED" != "$TESTER_BALANCE_REAL" ] && echoErr "ERROR TEST 1/1: Expected tester account balance to be '$TESTER_BALANCE_EXPECTED', but got '$TESTER_BALANCE_REAL'" && exit 1
   # <--- Send tokens

echoInfo "INFO: $TEST_NAME - Integration Test - END, elapsed: $(prettyTime $(timerSpan $TEST_NAME))"